<html><head>
    <link rel="icon" href='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IS0tIFVwbG9hZGVkIHRvOiBTVkcgUmVwbywgd3d3LnN2Z3JlcG8uY29tLCBHZW5lcmF0b3I6IFNWRyBSZXBvIE1peGVyIFRvb2xzIC0tPgo8c3ZnIHdpZHRoPSI4MDBweCIgaGVpZ2h0PSI4MDBweCIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTEyOS4yODQgMTU2LjA3MmE3MC42NTMgNzAuNjUzIDAgMCAwLTYuMjYyLTIuMjljLTEuNTY5LS40NzYtMy4xOC0uOTMyLTQuODUzLTEuMzAyYTYyLjQ4NCA2Mi40ODQgMCAwIDAtNS4wOTctLjkxMiA0Ny45NjcgNDcuOTY3IDAgMCAwLTUuMTM5LS4zODFoLTIuNTExYy0uODI2IDAtMS42NDIuMDk1LTIuNDM3LjE3YTM1LjYxMiAzNS42MTIgMCAwIDAtNC41MTQuNzQxIDMwLjg0NCAzMC44NDQgMCAwIDAtMy44NjcgMS4xNDVjLTEuMTc2LjM5Mi0yLjE5NC45LTMuMDk0IDEuMjkyLS45LjM5Mi0xLjYzMi44NTgtMi4yMzYgMS4yMDhsLTEuODQ0IDEuMTc2IDIuMTItLjQ0NWMuNjc4LS4xMTYgMS41MDQtLjIxMiAyLjQyNi0uMzM5LjkyMi0uMTI3IDEuOTgxLS4xNTkgMy4xNzktLjExNmEyNy4zOCAyNy4zOCAwIDAgMSAzLjYxMy4yNTQgMzAuNjQzIDMwLjY0MyAwIDAgMSAzLjkuNzczYy42NTYuMTggMS4zMjQuMzUgMS45OTEuNTk0LjY2OC4yNDMgMS4zMjUuNDU1IDEuOTkyLjczYTM5Ljk1NyAzOS45NTcgMCAwIDEgMy44ODkgMS44MDJjMS4yNi42ODkgMi41IDEuNDEgMy42NjYgMi4xOTMgMS4xNjUuNzg1IDIuMTIgMS40NTIgMy4wNzMgMi4xOTRhMzUuMzA1IDM1LjMwNSAwIDAgMSAxMi4wMDUtOC40ODd6bTI4Ny4yNSAzOS41NDNhNy40MTcgNy40MTcgMCAwIDEtNy40MTcgNy40MTdIMzA0Ljc4MXYtMTYuOTUzaDExMS43NTN6TTk5LjUgMjA3LjM2NWMtNDAuNzgzIDI3LjAzLTc3LjIxMSAxMTMuMDU3LTczLjE5NSAxNzAuNDk3aDk4LjU0cy0xNy45MDctNzEuMzg0IDYuNjc1LTk0Ljg4NWMuMzgyLS4zNi43ODQtLjcgMS4xOTgtMS4wNiAxMC45NjYtMTkuNDg1IDExLjE3OC0zNy41NjIuMzctNTIuNjI5LTkuNjEtMTMuNDI1LTI0LjgwNC0yMC40MTgtMzMuNTg4LTIxLjkyMnptLTEzLjAzMyAxMzcuNDlhMTIuNzE1IDEyLjcxNSAwIDEgMS0xMi43MTUtMTIuNzE0IDEyLjcxNSAxMi43MTUgMCAwIDEgMTIuNzE1IDEyLjcxNXptMzk1Ljg1Ny0yMTAuNTc5YTIuODA4IDIuODA4IDAgMCAxIDMuNjc3IDIuNjh2MzIuMTdIMzA0LjgxM1YxNDMuNzdoMTQ4LjA5NnpNMTI0LjE4NyAxOTguOTFoLS4xNTlhNzQuNTYyIDc0LjU2MiAwIDAgMSAyMi44MzQgMjAuNDkyYzE0LjMyNSAxOS45NDIgMTIuNzc4IDQwLjQyMyA3LjA4OSA1Ni41ODIgNS4zODIuMjIyIDEwLjA2NiAxLjY5NSAxMi4yMjcgNC40MThhNTUuNzQ0IDU1Ljc0NCAwIDAgMCA0My44NjYgMjEuMzVjMjMuMjM3IDAgNDUuMjEyLTE0LjY0MyA0OC40ODctNDEuNTAzYTIzLjYxOCAyMy42MTggMCAwIDAgMTguMTUtMTYuNTgybDExLjE1Ny0zOC4zMTVWMTM2LjQ4SDE1Ny45MTN2Ny4yMzdoLTExLjA1MXYyNS44NDNjLTI3LjU0OS4wNTMtMjIuNzE3IDI5LjM1LTIyLjcxNyAyOS4zNXptMTMwLjMzOC0zOC41MTVhOC40NzcgOC40NzcgMCAwIDEtOC40NzYgOC40NzZoLTU1LjU2NGE4LjQ3NyA4LjQ3NyAwIDAgMSAwLTE2Ljk1M2g1NS41NjRhOC40NzcgOC40NzcgMCAwIDEgOC40NzYgOC40Nzd6bTAgMjQuMzdhOC40NzcgOC40NzcgMCAwIDEtOC40NzYgOC40NzZoLTU1LjU2NGE4LjQ3NyA4LjQ3NyAwIDAgMSAwLTE2Ljk1M2g1NS41NjRhOC40NzcgOC40NzcgMCAwIDEgOC40NzYgOC40Nzd6bS04LjQ3NiAzMi4zMTdoLTU1LjU2NGE4LjQ3NyA4LjQ3NyAwIDEgMSAwLTE2Ljk1M2g1NS41NjRhOC40NzcgOC40NzcgMCAwIDEgMCAxNi45NTN6bS03MS4wNzYgNDMuNDQyYzAtMTQuMTI0IDguNDc2LTE1LjMyMSAyMC43NjctMTQuOTUuMjY1IDEuMjgyLjU2MiAyLjYwNi45MjIgMy45NjMuNDM0IDEuNTc4LjkgMy4xNzggMS40ODMgNC44LjU4MyAxLjYyIDEuMjMgMy4xNzggMS45NCA0LjhhNDguMDYyIDQ4LjA2MiAwIDAgMCAyLjQxNSA0LjU1NmMuNDI0LjczLjg4IDEuNDMgMS4zNTYgMi4xMTkuNDc3LjY4OC45NTQgMS4zMzUgMS40NDIgMS45N2EzNS41NyAzNS41NyAwIDAgMCAzLjAzIDMuNDM0IDMwLjc4IDMwLjc4IDAgMCAwIDMuMDMgMi42N2MuOTU0Ljc4NCAxLjkyOSAxLjM3NyAyLjczNCAxLjkyOC44MDUuNTUxIDEuNi45MzIgMi4yMTQgMS4yNWwxLjk4Mi45NDMtMS41MDUtMS41NTdjLS40NTUtLjUwOS0uOTg1LTEuMTU1LTEuNTc4LTEuODc2YTE3Ljk3MSAxNy45NzEgMCAwIDEtMS43Ni0yLjU4NSAyNy4zNDggMjcuMzQ4IDAgMCAxLTEuNzA1LTMuMTc5IDMwLjYzMiAzMC42MzIgMCAwIDEtMS40Mi0zLjcxOWMtLjIwMS0uNjU3LS40MDMtMS4zMTQtLjU1MS0yLjAwMi0uMTQ4LS42OS0uMzI5LTEuMzY3LS40NDUtMi4xMmEzOS45MzUgMzkuOTM1IDAgMCAxLS41NC00LjIzOCA0My45OCA0My45OCAwIDAgMS0uMDk2LTQuMjM4Yy4wNDItMS4zNzguMTI3LTIuNzg3LjI1NC00LjEyMi4wODUtLjc5NS4xOC0xLjU1Ny4yODctMi4zMWgxLjE2NWMxOS41NiAwIDM1LjQxMS00LjggMzUuNDExIDE0LjQ3NGEzNS40MTYgMzUuNDE2IDAgMCAxLTcwLjgzMy0uMDIxeiIvPjwvc3ZnPg==' type="image/svg+xml">
    <title>TeleGun - Decentralized P2P Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<link rel="stylesheet" href="styles/style.css">
<body class="crt-overlay">
    <div class="container">
        <header>
            <div class="ascii-art">
_____    _      _____ _   _ _   _ 
|_   _|  | |    |  __ \ | | | \ | |
  | | ___| | ___| |  \/ | | |  \| |
  | |/ _ \ |/ _ \ | __| | | | . ` |
  | |  __/ |  __/ |_\ \ |_| | |\  |
  \_/\___|_|\___|\____/\___/\_| \_/
</div>
            <h1>
  <a href="https://github.com/lao2r/telegun" target="_blank" rel="noopener noreferrer">
    <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" data-view-component="true">
      <path fill="#1dff1d" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
    </svg>
  </a>
</h1>
        </header>
        <div id="login-container">
            <button id="generate-room-button" style="display: block; margin: 0 auto 20px auto;">GENERATE RANDOM CHANNEL</button>
            <input type="text" id="room-input" placeholder="ENTER CHANNEL NAME" required="">
            <input type="text" id="nickname-input" placeholder="ENTER YOUR NICKNAME" required="">
            <button id="login-button">ENTER</button>
        </div>
        <div id="chat-interface" style="display: none;">
            <div id="room-info" style="position: relative; z-index: 1;">ENCRYPTED CHANNEL: <span id="channel-name"></span></div>
            <div id="chat-container">
        <link rel="stylesheet" href="styles/container.css">
        </div>
            <input type="text" id="message-input" placeholder="TYPE YOUR MESSAGE..." required="">
            <button id="send-button">TRANSMIT</button>
            <button id="leave-button">EXIT</button>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const loginContainer = document.getElementById('login-container');
    const chatInterface = document.getElementById('chat-interface');
    const chatContainer = document.getElementById('chat-container');
    const roomInput = document.getElementById('room-input');
    const nicknameInput = document.getElementById('nickname-input');
    const messageInput = document.getElementById('message-input');
    const loginButton = document.getElementById('login-button');
    const sendButton = document.getElementById('send-button');
    const leaveButton = document.getElementById('leave-button');
    const roomInfo = document.getElementById('room-info');
    const channelName = document.getElementById('channel-name');
    const generateRoomButton = document.getElementById('generate-room-button');

    let currentUser = null;
    let currentRoom = null;
    let chatRoom = null;
    const processedMessages = new Set();
    const blockedRooms = new Set();

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function showPopup(element, message) {
        const popup = document.createElement('div');
        popup.className = 'popup-text';
        popup.textContent = message;
        element.appendChild(popup);
        popup.style.display = 'block';
        setTimeout(() => {
            popup.style.display = 'none';
            popup.remove();
        }, 2000);
    }

    generateRoomButton.addEventListener('click', () => {
        const randomRoomName = generateUUID();
        roomInput.value = randomRoomName;
        navigator.clipboard.writeText(randomRoomName).then(() => {
            showPopup(generateRoomButton, 'COPIED TO CLIPBOARD');
        });
    });

    roomInfo.addEventListener('click', () => {
        navigator.clipboard.writeText(currentRoom).then(() => {
            showPopup(roomInfo, 'COPIED TO CLIPBOARD');
        });
    });

    loginButton.addEventListener('click', (e) => {
        e.preventDefault();
        const roomName = roomInput.value.trim();
        const nickname = nicknameInput.value.trim();
        if (roomName && nickname) {
            currentUser = nickname;
            currentRoom = roomName;
            chatRoom = gun.get(`telegun-chat-room-${roomName}`);
            loginContainer.style.display = 'none';
            chatInterface.style.display = 'block';
            channelName.textContent = roomName;
            chatRoom.get('users').set({ [nickname]: Date.now() });
            blockedRooms.delete(currentRoom);
            setupChatListeners();
            startMessageCleanup();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && currentUser) {
            const messageId = Date.now().toString();
            const expirationTime = Date.now() + 900000; // 15 minutes
            chatRoom.get('messages').get(messageId).put({
                sender: currentUser,
                content: message,
                timestamp: Date.now(),
                expireTime: expirationTime
            });
            messageInput.value = '';
        }
    }

    sendButton.addEventListener('click', (e) => {
        e.preventDefault();
        sendMessage();
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    leaveButton.addEventListener('click', () => {
        if (currentUser && chatRoom) {
            chatRoom.get('users').get(currentUser).put(null);
            blockedRooms.add(currentRoom);
            currentUser = null;
            currentRoom = null;
            chatRoom = null;
            chatContainer.innerHTML = '';
            chatInterface.style.display = 'none';
            loginContainer.style.display = 'block';
            roomInput.value = '';
            nicknameInput.value = '';
            processedMessages.clear();
        }
    });

    function displayMessage(id, sender, content, timestamp) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.setAttribute('data-id', id);

        const senderSpan = document.createElement('span');
        senderSpan.classList.add('sender');
        senderSpan.textContent = sender;

        const contentSpan = document.createElement('span');
        contentSpan.classList.add('content');
        contentSpan.textContent = `: ${content}`;

        const timestampSpan = document.createElement('span');
        timestampSpan.classList.add('timestamp');
        timestampSpan.textContent = ` [${formatDate(timestamp)}]`;

        messageElement.appendChild(senderSpan);
        messageElement.appendChild(contentSpan);
        messageElement.appendChild(timestampSpan);
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    }

    const messageQueue = [];
    let isProcessing = false;

    function processNextMessage() {
        if (messageQueue.length > 0 && !isProcessing) {
            isProcessing = true;
            const { message, id } = messageQueue.shift();
            processMessage(message, id);
            isProcessing = false;
            setTimeout(processNextMessage, 50); // Process next message after 50 ms
        }
    }

    function processMessage(message, id) {
        if (message && message.sender && message.content && message.timestamp && !processedMessages.has(id)) {
            if (message._ && typeof message._['#'] === 'string') {
                const messageRoom = message._['#'].split('/')[0];
                if (messageRoom === `telegun-chat-room-${currentRoom}` && !blockedRooms.has(currentRoom)) {
                    displayMessage(id, message.sender, message.content, message.timestamp);
                    processedMessages.add(id);
                }
            }
        }
    }

    function setupChatListeners() {
        if (chatRoom) {
            chatRoom.get('messages').map().on(function (message, id) {
                messageQueue.push({ message, id });
                processNextMessage();
            });
        }
    }

    function startMessageCleanup() {
        setInterval(() => {
            if (chatRoom) {
                chatRoom.get('messages').map((message, id) => {
                    if (message && message.expireTime && Date.now() > message.expireTime) {
                        chatRoom.get('messages').get(id).put(null);
                        const messageElement = document.querySelector(`[data-id="${id}"]`);
                        if (messageElement) {
                            messageElement.remove();
                        }
                    }
                });
            }
        }, 60000); // Check for expired messages every 60 seconds
    }
</script></body></html>
