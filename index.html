<html><head><title>TeleGun - Decentralized P2P Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<link rel="stylesheet" href="styles/style.css">
<body class="crt-overlay">
    <div class="container">
        <header>
            <div class="ascii-art">
_____    _      _____ _   _ _   _ 
|_   _|  | |    |  __ \ | | | \ | |
  | | ___| | ___| |  \/ | | |  \| |
  | |/ _ \ |/ _ \ | __| | | | . ` |
  | |  __/ |  __/ |_\ \ |_| | |\  |
  \_/\___|_|\___|\____/\___/\_| \_/
</div>
            <h1>
  <a href="https://github.com/lao2r/telegun" target="_blank" rel="noopener noreferrer">
    <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" data-view-component="true">
      <path fill="#1dff1d" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
    </svg>
  </a>
</h1>
        </header>
        <div id="login-container">
            <button id="generate-room-button" style="display: block; margin: 0 auto 20px auto;">GENERATE RANDOM CHANNEL</button>
            <input type="text" id="room-input" placeholder="ENTER CHANNEL NAME" required="">
            <input type="text" id="nickname-input" placeholder="ENTER YOUR NICKNAME" required="">
            <button id="login-button">ENTER</button>
        </div>
        <div id="chat-interface" style="display: none;">
            <div id="room-info" style="position: relative; z-index: 1;">ENCRYPTED CHANNEL: <span id="channel-name"></span></div>
            <div id="chat-container">
        <link rel="stylesheet" href="styles/container.css">
        </div>
            <input type="text" id="message-input" placeholder="TYPE YOUR MESSAGE..." required="">
            <button id="send-button">TRANSMIT</button>
            <button id="leave-button">EXIT</button>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);

        const loginContainer = document.getElementById('login-container');
        const chatInterface = document.getElementById('chat-interface');
        const chatContainer = document.getElementById('chat-container');
        const roomInput = document.getElementById('room-input');
        const nicknameInput = document.getElementById('nickname-input');
        const messageInput = document.getElementById('message-input');
        const loginButton = document.getElementById('login-button');
        const sendButton = document.getElementById('send-button');
        const leaveButton = document.getElementById('leave-button');
        const roomInfo = document.getElementById('room-info');
        const channelName = document.getElementById('channel-name');
        const generateRoomButton = document.getElementById('generate-room-button');

        let currentUser = null;
        let currentRoom = null;
        let chatRoom = null;
        const processedMessages = new Set();
        const blockedRooms = new Set();

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showPopup(element, message) {
            const popup = document.createElement('div');
            popup.className = 'popup-text';
            popup.textContent = message;
            element.appendChild(popup);
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
                popup.remove();
            }, 2000);
        }

        generateRoomButton.addEventListener('click', () => {
            const randomRoomName = generateUUID();
            roomInput.value = randomRoomName;
            navigator.clipboard.writeText(randomRoomName).then(() => {
                showPopup(generateRoomButton, 'COPIED TO CLIPBOARD');
            });
        });

        roomInfo.addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoom).then(() => {
                showPopup(roomInfo, 'COPIED TO CLIPBOARD');
            });
        });

        loginButton.addEventListener('click', (e) => {
            e.preventDefault();
            const roomName = roomInput.value.trim();
            const nickname = nicknameInput.value.trim();
            if (roomName && nickname) {
                currentUser = nickname;
                currentRoom = roomName;
                chatRoom = gun.get(`telegun-chat-room-${roomName}`);
                loginContainer.style.display = 'none';
                chatInterface.style.display = 'block';
                channelName.textContent = roomName;
                chatRoom.get('users').set({ [nickname]: Date.now() });
                blockedRooms.delete(currentRoom);
                setupChatListeners();
            }
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && currentUser) {
                const messageId = Date.now().toString();
                chatRoom.get('messages').get(messageId).put({
                    sender: currentUser,
                    content: message,
                    timestamp: Date.now()
                });
                messageInput.value = '';
            }
        }

        sendButton.addEventListener('click', (e) => {
            e.preventDefault();
            sendMessage();
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        leaveButton.addEventListener('click', () => {
            if (currentUser && chatRoom) {
                chatRoom.get('users').get(currentUser).put(null);
                blockedRooms.add(currentRoom);
                currentUser = null;
                currentRoom = null;
                chatRoom = null;
                chatContainer.innerHTML = '';
                chatInterface.style.display = 'none';
                loginContainer.style.display = 'block';
                roomInput.value = '';
                nicknameInput.value = '';
                processedMessages.clear();
            }
        });

        function displayMessage(sender, content, timestamp) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const senderSpan = document.createElement('span');
            senderSpan.classList.add('sender');
            senderSpan.textContent = sender;

            const contentSpan = document.createElement('span');
            contentSpan.classList.add('content');
            contentSpan.textContent = `: ${content}`;

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.textContent = ` [${formatDate(timestamp)}]`;

            messageElement.appendChild(senderSpan);
            messageElement.appendChild(contentSpan);
            messageElement.appendChild(timestampSpan);

            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        const messageQueue = [];
        let isProcessing = false;

        function processNextMessage() {
            if (messageQueue.length > 0 && !isProcessing) {
                isProcessing = true;
                const { message, id } = messageQueue.shift();
                processMessage(message, id);
                isProcessing = false;
                setTimeout(processNextMessage, 50);  // Обработка следующего сообщения через 50 мс
            }
        }

        function processMessage(message, id) {
            if (message && message.sender && message.content && message.timestamp && !processedMessages.has(id)) {
                if (message._ && typeof message._['#'] === 'string') {
                    const messageRoom = message._['#'].split('/')[0];
                    if (messageRoom === `telegun-chat-room-${currentRoom}` && !blockedRooms.has(currentRoom)) {
                        displayMessage(message.sender, message.content, message.timestamp);
                        processedMessages.add(id);
                    }
                }
            }
        }

        function setupChatListeners() {
            if (chatRoom) {
                chatRoom.get('messages').map().on(function (message, id) {
                    messageQueue.push({ message, id });
                    processNextMessage();
                });
            }
        }
</script></body></html>
